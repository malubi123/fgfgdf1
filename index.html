<script src="https://cdn.jsdelivr.net/npm/gif.js/dist/gif.js"></script>

<script>
document.getElementById('generate').addEventListener('click', () => {
    const fileInput = document.getElementById('srtFile');
    if (!fileInput.files[0]) return alert('Wybierz plik SRT!');
    
    const font = document.getElementById('font').value;
    const fontSize = parseInt(document.getElementById('fontSize').value);
    const color = document.getElementById('color').value;
    const bgColor = document.getElementById('bgColor').value;
    
    const reader = new FileReader();
    reader.onload = e => {
        const srtText = e.target.result;
        const subtitles = parseSRT(srtText);
        generateGIF(subtitles, font, fontSize, color, bgColor);
    };
    reader.readAsText(fileInput.files[0]);
});

function parseSRT(data) {
    const regex = /(\d+)\s+(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\s+([\s\S]*?)(?=\n\n|\n*$)/g;
    const subtitles = [];
    let match;
    while ((match = regex.exec(data)) !== null) {
        subtitles.push({
            start: timeToMs(match[2]),
            end: timeToMs(match[3]),
            text: match[4].replace(/\r/g,'').replace(/\n/g,' ')
        });
    }
    return subtitles;
}

function timeToMs(time) {
    const [h,m,sms] = time.split(':');
    const [s, ms] = sms.split(',');
    return parseInt(h)*3600000 + parseInt(m)*60000 + parseInt(s)*1000 + parseInt(ms);
}

function generateGIF(subtitles, font, fontSize, color, bgColor) {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 500;
    canvas.height = 100;

    const gif = new GIF({ workers: 1, quality: 10 });

    subtitles.forEach(sub => {
        const duration = sub.end - sub.start;
        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = color;
        ctx.font = fontSize + 'px ' + font;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(sub.text, canvas.width/2, canvas.height/2);
        gif.addFrame(ctx, {copy: true, delay: duration});
    });

    gif.on('finished', blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'subtitles.gif';
        a.click();
    });

    gif.render();
}
</script>
